generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum USER_TYPES {
  user
  admin
}

enum FREQUENCY {
  monthly
  yearly
  quarterly
  biannually
  unlimited
}

model Country {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  ISOCode   String  @unique
  name      String
  phoneCode String  @unique
  User      User[]
  isDeleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Plan {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  globalPrice Float
  egPrice     Float
  frequency   FREQUENCY
  qeriesCount Int           @default(0)
  isActive    Boolean       @default(true)
  isDeleted   Boolean       @default(false)
  users       User[]
  Transaction Transaction[]

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  Subscription Subscription[]
}

model GoogleData {
  id             String  @id @default(auto()) @map("_id") @db.ObjectId
  sub            String
  name           String
  given_name     String
  family_name    String
  picture        String
  email          String  @unique
  email_verified Boolean
  User           User[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id             String     @id @default(auto()) @map("_id") @db.ObjectId
  name           String
  email          String     @unique
  password       String?
  phone          String?
  speciality     String?
  paidUser       Boolean    @default(false)
  activeUntil    DateTime?
  role           USER_TYPES @default(user)
  emailVerified  Boolean    @default(false)
  phoneVerified  Boolean    @default(false)
  autoRenewal    Boolean    @default(false)
  code           Int?
  socialProvider String?
  isBlocked      Boolean?   @default(false)
  isDeleted      Boolean?   @default(false)
  Plan           Plan?      @relation(fields: [planId], references: [id])
  planId         String?    @db.ObjectId

  Country   Country? @relation(fields: [countryId], references: [id])
  countryId String?  @db.ObjectId

  googleData   GoogleData? @relation(fields: [googleDataId], references: [id])
  googleDataId String?     @db.ObjectId

  Transaction Transaction[]

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  Subscription Subscription[]

  @@index([name, email, phone, paidUser])
}

model Transaction {
  id            String @id @default(auto()) @map("_id") @db.ObjectId
  paymentMethod String
  stripe        Json
  tran_ref      String

  user   User   @relation(fields: [userId], references: [id])
  userId String @db.ObjectId

  plan   Plan   @relation(fields: [planId], references: [id])
  planId String @db.ObjectId

  Subscription Subscription[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subscription {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  startDate    DateTime @default(now())
  endDate      DateTime
  totalQueries Int
  usedQuries   Int      @default(0)
  isActive     Boolean  @default(false)
  price        Float
  user         User     @relation(fields: [userId], references: [id])
  userId       String   @db.ObjectId

  plan   Plan   @relation(fields: [planId], references: [id])
  planId String @db.ObjectId

  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  transactionId String?      @db.ObjectId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
